import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

const supabase = createClient(
  Deno.env.get('SUPABASE_URL') ?? '',
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
);

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { conversationId } = await req.json();
    
    console.log(`Processing message buffer for conversation: ${conversationId}`);

    // Buscar buffer n√£o processado para esta conversa
    const { data: buffer, error: bufferError } = await supabase
      .from('message_buffers')
      .select('*')
      .eq('conversation_id', conversationId)
      .eq('processed', false)
      .single();

    if (bufferError || !buffer) {
      console.log('No active buffer found or already processed');
      return new Response(JSON.stringify({ processed: false }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }

    // Verificar se j√° passou tempo suficiente
    const now = new Date();
    const shouldProcessAt = new Date(buffer.should_process_at);
    
    if (now < shouldProcessAt) {
      console.log('Buffer still within waiting period');
      return new Response(JSON.stringify({ processed: false, waiting: true }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }

    // Marcar buffer como processado
    await supabase
      .from('message_buffers')
      .update({
        processed: true,
        processed_at: now.toISOString()
      })
      .eq('id', buffer.id);

    // Agrupar todas as mensagens do buffer
    const messages = buffer.messages || [];
    const combinedMessage = messages.map(msg => msg.content).join(' ');

    console.log(`Processing combined message: ${combinedMessage}`);

    // Buscar dados da conversa
    const { data: conversation, error: convError } = await supabase
      .from('conversations')
      .select('*')
      .eq('id', conversationId)
      .single();

    if (convError || !conversation) {
      throw new Error('Conversation not found');
    }

    // Classificar inten√ß√£o usando LLM
    const classificationResult = await supabase.functions.invoke('classify-intent-llm', {
      body: {
        message: combinedMessage,
        currentProductGroup: conversation.product_group,
        conversationId
      }
    });

    // Extrair dados do cliente em paralelo
    const extractionResult = await supabase.functions.invoke('extract-customer-data', {
      body: {
        conversationId,
        newMessage: combinedMessage
      }
    });

    let newProductGroup = conversation.product_group;
    
    if (classificationResult.data?.productGroup) {
      newProductGroup = classificationResult.data.productGroup;
      
      // Atualizar product_group na conversa se mudou
      if (newProductGroup !== conversation.product_group) {
        await supabase
          .from('conversations')
          .update({ product_group: newProductGroup })
          .eq('id', conversationId);
      }
    }

    // Gerar resposta usando o novo sistema de agentes inteligentes
    const agentResponse = await supabase.functions.invoke('intelligent-agent-response', {
      body: {
        message: combinedMessage,
        conversationId,
        productCategory: newProductGroup
      }
    });

    let botResponse = {
      text: "Ol√°! Um especialista entrar√° em contato em breve.",
      transferToHuman: false
    };

    if (agentResponse.data?.response) {
      botResponse = {
        text: agentResponse.data.response,
        transferToHuman: false
      };
    }

    // Salvar resposta do bot
    await supabase
      .from('messages')
      .insert({
        conversation_id: conversationId,
        content: botResponse.text,
        sender_type: 'bot',
        status: 'sent'
      });

    // Enviar mensagem via WhatsApp
    await supabase.functions.invoke('send-whatsapp-message', {
      body: {
        to: conversation.whatsapp_number,
        message: botResponse.text
      }
    });

    // Atualizar status da conversa se necess√°rio
    if (botResponse.transferToHuman) {
      await supabase
        .from('conversations')
        .update({
          status: 'transferred_to_human',
          last_message_at: now.toISOString()
        })
        .eq('id', conversationId);
    } else {
      await supabase
        .from('conversations')
        .update({
          last_message_at: now.toISOString()
        })
        .eq('id', conversationId);
    }

    return new Response(JSON.stringify({ 
      processed: true,
      productGroup: newProductGroup,
      responseText: botResponse.text
    }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });

  } catch (error) {
    console.error('Error processing message buffer:', error);
    
    await supabase.from('system_logs').insert({
      level: 'error',
      source: 'process-message-buffer',
      message: 'Failed to process message buffer',
      data: { error: error.message }
    });

    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  }
});

// Importar agentes necess√°rios
class BaseAgent {
  protected companyInfo = {
    name: 'Drystore',
    phone: '(51) 99999-0000',
    address: 'Porto Alegre, RS',
    website: 'www.drystore.com.br',
    specialties: [
      'Energia Solar - Parceiro GE',
      'Telhas Shingle - Telhado dos Sonhos',
      'Steel Frame - Constru√ß√£o Seca',
      'Drywall - Divis√≥rias e Forros',
      'Ferramentas Profissionais',
      'Pisos e Acabamentos'
    ]
  };

  protected getGreeting(): string {
    const hour = new Date().getHours();
    if (hour < 12) return 'Bom dia';
    if (hour < 18) return 'Boa tarde';
    return 'Boa noite';
  }

  protected extractContextualInfo(message: string) {
    const lowerMessage = message.toLowerCase();
    return {
      hasUrgency: /urgente|hoje|agora|r√°pido|imediato/.test(lowerMessage),
      wantsContact: /contato|telefone|ligar|falar|atendente/.test(lowerMessage),
      wantsBudget: /pre√ßo|valor|quanto|or√ßamento|custo/.test(lowerMessage),
      mentionedCompetitor: /concorrente|outro|empresa|comparar/.test(lowerMessage)
    };
  }
}

class GeneralAgent extends BaseAgent {
  async generateResponse(message, conversationData) {
    const messageCount = conversationData.messages?.length || 0;

    // Greeting flow
    if (messageCount <= 2 || message.match(/oi|ol√°|ola|bom dia|boa tarde|boa noite|hello|hey/i)) {
      return {
        text: `${this.getGreeting()}! üëã Bem-vindo √† **${this.companyInfo.name}**! 

Somos especialistas em solu√ß√µes completas para constru√ß√£o civil:

üåü **Nossas especialidades:**
${this.companyInfo.specialties.map(spec => `‚Ä¢ ${spec}`).join('\n')}

Em que posso te ajudar hoje?`,
        transferToHuman: false
      };
    }

    // Default helpful response
    return {
      text: `üòä **Como posso te ajudar hoje?**

**Principais servi√ßos da ${this.companyInfo.name}:**
‚ö° **Energia Solar** - Economia na conta de luz
üè† **Telha Shingle** - Telhados modernos e dur√°veis  
üèóÔ∏è **Steel Frame** - Constru√ß√£o r√°pida e econ√¥mica
üß± **Drywall** - Divis√≥rias e forros profissionais
üîß **Ferramentas** - Equipamentos das melhores marcas
üé® **Acabamentos** - Pisos, tintas e revestimentos

**O que voc√™ est√° procurando?**
Posso te dar informa√ß√µes detalhadas sobre qualquer um dos nossos produtos e servi√ßos!`,
      transferToHuman: false
    };
  }
}

class SpecializedAgentFactory {
  getAgent(category) {
    // Para categorias espec√≠ficas, retornar agentes especializados inline
    switch(category) {
      case 'energia_solar':
        return {
          async generateResponse(message, conversationData) {
            return {
              text: `Que bom que voc√™ tem interesse em energia solar! üåû

√â uma das melhores formas de reduzir drasticamente sua conta de luz. Nossa parceria com a GE nos permite oferecer sistemas de alta qualidade.

Para te ajudar melhor, voc√™ pode me contar qual o valor da sua conta de energia atual?`,
              transferToHuman: false
            };
          }
        };
      
      case 'telha_shingle':
        return {
          async generateResponse(message, conversationData) {
            return {
              text: `As telhas shingle s√£o realmente uma excelente escolha para seu telhado! üè†

Elas oferecem:
‚úÖ Beleza e modernidade
‚úÖ Durabilidade superior (at√© 30 anos)
‚úÖ Prote√ß√£o contra intemp√©ries
‚úÖ Instala√ß√£o r√°pida e eficiente

Voc√™ j√° tem o projeto definido ou ainda est√° na fase de planejamento?`,
              transferToHuman: false
            };
          }
        };

      case 'steel_frame':
        return {
          async generateResponse(message, conversationData) {
            return {
              text: `Steel frame √© uma tecnologia incr√≠vel para constru√ß√£o! üèóÔ∏è

**Vantagens:**
‚ö° Constru√ß√£o at√© 70% mais r√°pida
üí∞ Economia de at√© 30% no custo total
üå± Sustent√°vel e ecol√≥gica
üè† Estrutura resistente e dur√°vel

Voc√™ j√° tem o projeto arquitet√¥nico ou ainda est√° na fase inicial de planejamento?`,
              transferToHuman: false
            };
          }
        };

      case 'drywall_divisorias':
        return {
          async generateResponse(message, conversationData) {
            return {
              text: `Drywall √© perfeito para divis√≥rias e acabamentos de qualidade! üß±

**Benef√≠cios:**
üöÄ Instala√ß√£o r√°pida e limpa
üé® Acabamento profissional
üîß Facilidade para instala√ß√µes el√©tricas
üí° Isolamento ac√∫stico e t√©rmico

Qual ambiente voc√™ pretende trabalhar? Residencial ou comercial?`,
              transferToHuman: false
            };
          }
        };

      case 'ferramentas':
        return {
          async generateResponse(message, conversationData) {
            return {
              text: `Temos uma linha completa de ferramentas profissionais! üîß

**Marcas dispon√≠veis:**
‚ö° Makita - Qualidade japonesa
üî• DeWalt - Resist√™ncia profissional  
üõ†Ô∏è Bosch - Tecnologia alem√£
üî® Stanley - Tradi√ß√£o americana

Qual ferramenta voc√™ est√° buscando? Posso te ajudar a encontrar a ideal para sua necessidade.`,
              transferToHuman: false
            };
          }
        };

      case 'pisos':
        return {
          async generateResponse(message, conversationData) {
            return {
              text: `Nossos pisos oferecem qualidade e beleza para transformar seu ambiente! üè†

**Op√ß√µes dispon√≠veis:**
üåü Piso vin√≠lico - Resistente e moderno
ü™µ Piso laminado - Beleza da madeira
üß± Porcelanato - Eleg√¢ncia e durabilidade
üè¢ Carpete comercial - Conforto e praticidade

Voc√™ tem ideia de quantos metros quadrados precisa ou quais ambientes vai revestir?`,
              transferToHuman: false
            };
          }
        };

      case 'acabamentos':
        return {
          async generateResponse(message, conversationData) {
            return {
              text: `Temos uma linha completa de acabamentos para deixar seu projeto perfeito! üé®

**Produtos dispon√≠veis:**
üé® Tintas premium - Suvinil, Coral
‚ú® Texturas especiais - Efeitos √∫nicos
ü™µ Vernizes e stains - Prote√ß√£o da madeira
üåà Consultoria de cores - Harmoniza√ß√£o perfeita

Qual tipo de acabamento voc√™ est√° procurando?`,
              transferToHuman: false
            };
          }
        };

      case 'forros':
        return {
          async generateResponse(message, conversationData) {
            return {
              text: `Nossos forros s√£o ideais para dar o acabamento perfeito ao seu ambiente! ‚ú®

**Tipos dispon√≠veis:**
üè† Forro de gesso - Eleg√¢ncia cl√°ssica
üí° Forro com ilumina√ß√£o - Modernidade
üå°Ô∏è Forro t√©rmico - Conforto e economia
üéµ Forro ac√∫stico - Isolamento sonoro

Qual tipo de ambiente voc√™ quer instalar o forro? Residencial, comercial ou industrial?`,
              transferToHuman: false
            };
          }
        };

      default:
        return new GeneralAgent();
    }
  }
}

// Fun√ß√£o para gerar resposta usando agentes reais
async function generateSpecializedResponse(
  message: string,
  productGroup: string,
  conversation: any,
  customerData: any
) {
  try {
    // Buscar mensagens da conversa para contexto
    const { data: messages } = await supabase
      .from('messages')
      .select('content, sender_type, created_at')
      .eq('conversation_id', conversation.id)
      .order('created_at', { ascending: true });

    // Preparar dados da conversa para o agente
    const conversationData = {
      ...conversation,
      messages: messages || [],
      project_contexts: customerData
    };

    // Usar agente geral para categorias indefinidas ou sauda√ß√£o
    if (['indefinido', 'saudacao', 'institucional'].includes(productGroup)) {
      const generalAgent = new GeneralAgent();
      const response = await generalAgent.generateResponse(message, conversationData);
      return {
        text: response.text,
        transferToHuman: response.transferToHuman || false
      };
    } else {
      // Usar agente especializado via factory
      const factory = new SpecializedAgentFactory();
      const agent = factory.getAgent(productGroup);
      const response = await agent.generateResponse(message, conversationData);
      return {
        text: response.text,
        transferToHuman: response.transferToHuman || false
      };
    }

  } catch (error) {
    console.error('Error generating specialized response:', error);
    return {
      text: `Ol√°! Obrigado por entrar em contato. Um de nossos especialistas ir√° te atender em breve!`,
      transferToHuman: true
    };
  }
}